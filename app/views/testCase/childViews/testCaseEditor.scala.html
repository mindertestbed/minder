@(frm: Form[_], editMode: Boolean = true)

@import helper._
@import views.html.util._

@implicitFieldConstructor = @{
  FieldConstructor(myInput.f)
}

@getOrDummy() = @{
  val id = frm("id").value
  if (id == null || id.length == 0){
    val ta = TestAssertion.findById(frm("assertionId").value.toLong)
    val tc = new TestCase
    tc.name = "New Test Case"
    tc.testAssertion = ta
    tc
  } else {
    Tdl.findById(id.toLong).testCase
  }
}

@defining(getOrDummy()) { tc =>
  @main(Messages("minder.navigation.restricted.testdesigner"), "mainNavigation",
    Array(("Test Groups", controllers.routes.Application.testGroups().path()),
      (tc.testAssertion.testGroup.name, controllers.routes.GroupController.getGroupDetailView(tc.testAssertion.testGroup.id, "assertions").path()),
      (tc.testAssertion.taId, controllers.routes.TestAssertionController.getAssertionDetailView(tc.testAssertion.id, "cases").path()),
      (tc.name, controllers.routes.TestCaseController.viewTestCase(tc.id, "jobs").path()))) {

    @dialogs()
    <link rel="stylesheet" href="@routes.Assets.versioned("stylesheets/theme/3024-day.css")" rel="stylesheet">
    <link rel="stylesheet" href="@routes.Assets.versioned("stylesheets/theme/ambiance.css")" rel="stylesheet">
    <link rel="stylesheet" href="@routes.Assets.versioned("stylesheets/theme/cobalt.css")" rel="stylesheet">
    <link rel="stylesheet" href="@routes.Assets.versioned("stylesheets/theme/eclipse.css")" rel="stylesheet">
    <link rel="stylesheet" href="@routes.Assets.versioned("stylesheets/theme/mdn-like.css")" rel="stylesheet">
    <link rel="stylesheet" href="@routes.Assets.versioned("stylesheets/theme/neat.css")" rel="stylesheet">
    <link rel="stylesheet" href="@routes.Assets.versioned("stylesheets/theme/neo.css")" rel="stylesheet">

    <style>
    #accordion1 {
    height: 100% ;
    overflow:scroll ;
    }

    .myscroll {
    overflow:scroll ;
    width:100% ;

    background: rgb(200,230,255) ;
    }


    </style>

    <script>

        $(function() {
          minderAccordion("#accordion1");
          var textArea = document.getElementById("tdl");
          var editor = CodeMirror.fromTextArea(textArea, {
            lineNumbers: true,
            lineWrapping: true,
            styleActiveLine: true,
            viewportMargin: Infinity,
            extraKeys: {"Ctrl-Space": "autocomplete"},
            mode: {name: "text/x-scala", globalVars: true},
            theme: "mdn-like"
          });

          // store it
          $("#tdl").data('CodeMirrorInstance', editor);

          editor.on("change", function(cm, change) {
            textArea.value = editor.getDoc().getValue();
          });

          $( "#select" ).change(function() {
            $( "#select option:selected" ).each(function() {
              editor.setOption("theme", $( this ).text());
            });

          });

          document.onkeydown = function(event){
            if (event.which == 27){
              $("#wrappersDiv" ).hide();
              $ ( "#funcdiv" ).hide ( ) ;
            }
          };
        });
    </script>
    @defining(if(editMode == false) {
      routes.TestCaseController.doCreateCase()
    } else {
      routes.TestCaseController.doEditCase()
    }) { act =>
      @helper.form(action = act, 'class -> "fullh") {
        <div id="contentPane" style="position:absolute ; top:0px ; left:3px ; bottom: 3px ; right: 3px ;">
          <div class="bevel2" style="position:absolute ; width:100% ; height:50px ; margin:0 ; padding:10px ;">
            <table style="width: 100% ;">
              <tr>
                <td class="tabshrink">
                  <b>Test Case: </b>
                  @if(!editMode) {
                    <input type="text" name="name" value='@frm("name").value' style="border: 1px solid lightgrey ; background: white ; width:200px ;"/>
                  } else {
                    @frm("name").value
                    <input type="hidden" name="name" id="name" value='@frm("name").value'/>
                  }</td>
                <td class="tabshrink">
                    &nbsp;
                  <b>V</b>
                  : <input type="text" name="version" value='@frm("version").value' style="border: 1px solid lightgrey ; background: white ; width:40px ;"/>
                </td>
                <td align="right">
                  <table><tr><td>

                    <b>Theme</b>: <select id="select">
                    <option>3024-day</option>
                    <option>ambiance</option>
                    <option>cobalt</option>
                    <option>eclipse</option>
                    <option selected>mdn-like</option>
                    <option>neat</option>
                    <option>neo</option>
                  </select>
                    <button onclick='$("#wrappersDiv").show();' type="button">Insert Reference</button>
                      &nbsp;
                    <button onclick='$ ( "#funcdiv" ).show( );' type="button">Insert Converter</button>
                      &nbsp;&nbsp;&nbsp;&nbsp;
                  <td align="right">
                    <button type="submit">Save</button>&nbsp;
                    <button type="reset">Reset</button>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                    <button type="button" onclick="history.back ( )">Cancel</button>
                  </td></tr></table>

                </td>
              </tr>
            </table>
          </div>
          <div style="position:absolute ; top:50px ; left:0 ; right:0 ; bottom: 0 ; margin:0 ; padding:5px ; overflow:auto ;">
            @if(frm.hasErrors) {
              <p id="error" class="alert alert-danger" style='font-family:"Monaco", "Courier New", "monospace"'></p>
              <xmp id="source" style="display: none">
                @if(frm.hasGlobalErrors) {
                  @frm.globalError
                }
                @if(frm.hasErrors) {
                  @for( error <- frm.errors) {
                    @for( err <- error._2) {
                      @error._1: @Messages(err.message)
                    }
                  }
                }
              </xmp>

              <script>
                  function trimAll(arr){
                    var arr2 = new Array()
                    for(a in arr){
                      arr[a] =arr[a].trim()
                      if (arr[a].length > 0) arr2.push(arr[a])
                    }
                    return arr2;
                  }
                  $(function(){
                    var newd  = $("#source" ).text()
                    newd = trimAll(newd.split(/\n/g)).join("<br/>");
                    newd = newd.replace(/ /g, '&nbsp;')
                    $("#error")[0 ].innerHTML = newd.trim();
                  });
              </script>
            }

            <textarea id="tdl" name="tdl" class = "CodeMirror">@frm("tdl").value </textarea>
            @defining(if(frm("tdl").value == null) {
              ""
            } else {
              frm("tdl").value
            }) { str =>
              @defining(str.toString.split("\\\n").length) { len =>
                <script>
                    $(function(){
                      var editor = $("#tdl").data('CodeMirrorInstance');

                      var nls = "";
                      for(i = @len; i < 20; i++){
                        nls += "\n"
                      }

                      editor.replaceRange(nls, CodeMirror.Pos(editor.lastLine()))
                    });
                </script>
              }
            }

          </div>

          <div class="bevel2" style="z-index:10000000 ; position:fixed ; width:60% ; height:60% ; top:20% ; left:20% ; display:none ; overflow:scroll ; border:1px solid gray ; background-color:#ffffff" id="wrappersDiv">
            <div id="accordion1" class="fullh">
            @defining(Wrapper.getAll()) { allWrappers =>
              @for( currentWrapper <- allWrappers) {
                @defining(WrapperVersion.latestByWrapper(currentWrapper)) { lastVersion =>
                  <div class="title bevelsmall"><b class="trigger">@currentWrapper.name</b></div>
                  <div class="content" style="height:95%">
                    <div class="myscroll" style="overflow:auto ;">
                    @if(lastVersion == null) {
                      The wrapper should connect at least once, to update its version and signatures.
                    } else {
                      <div><b>Signals</b></div>
                      <div style="overflow:scroll"> <ul>
                      @if(lastVersion.signals == null) {
                        No signals yet. The wrapper must connect at least once to update the signatures
                      } else {
                        @for( currentSignal <- lastVersion.signals) {
                          <li id="signal@lastVersion.id-@currentSignal.id">- @currentSignal.signature</li>
                          <script>
                      $("#signal@lastVersion.id-@currentSignal.id").click(function(){
                        // get it
                        var editor = $("#tdl").data('CodeMirrorInstance');
                        // from here on the API functions are available to 'myInstance' again.
                        var start_cursor = editor.getCursor();
                        var cursorLine = start_cursor.line;
                        var cursorCh = start_cursor.ch;
                        editor.replaceRange("\"@currentSignal.signature\" of \"@currentWrapper.name\"", start_cursor);
                        $("#wrappersDiv" ).hide();
                      });

                      </script>
                        }
                      }
                      </ul></div>
                        &nbsp;
                      <div><b>Slots</b></div>
                      <div style="overflow:scroll">
                        <ul>
                        @if(lastVersion.slots == null) {
                          No slots yet. The wrapper must connect at least once to update the signatures
                        } else {
                          @for( currentSlot <- lastVersion.slots) {
                            <li id="slot@lastVersion.id-@currentSlot.id">- @currentSlot.signature</li>
                            <script>
                      $("#slot@lastVersion.id-@currentSlot.id").click(function(){
                        // get it
                        var editor = $("#tdl").data('CodeMirrorInstance');
                        // from here on the API functions are available to 'myInstance' again.
                        var start_cursor = editor.getCursor();
                        var cursorLine = start_cursor.line;
                        var cursorCh = start_cursor.ch;
                        editor.replaceRange("\"@currentSlot.signature\" of \"@currentWrapper.name\"", start_cursor);
                        $("#wrappersDiv" ).hide();
                      });

                      </script>
                          }
                        }
                        </ul></div>
                    }
                    </div>
                  </div>
                }
              }
            }
            </div>
          </div>


          <div class="bevel2" style="z-index:10000000 ; position:fixed ; width:30% ; height:20% ; padding:20px ; top:40% ; left:35% ; display:none ; overflow:scroll ; border:1px solid gray ; background-color:#ffffff" id="funcdiv">

            <h3>Create New Converter</h3>

            <label for="converterName">Converter Name</label>
            <input type="text" id="converterName" class="fullw fcborder"/>
            <br />

            <script>
                function addConverter() {
                  // get it
                  var editor = $ ( "#tdl" ).data ( 'CodeMirrorInstance' ) ;
                  // from here on the API functions are available to 'myInstance' again.
                  var start_cursor = editor.getCursor ( ) ;
                  var cursorLine = start_cursor.line ;
                  var cursorCh = start_cursor.ch ;
                  editor.replaceRange ( "def " + $ ( "#converterName" ).val() + "(input: Any) : Any ={\n\n}", start_cursor ) ;
                  $ ( "#funcdiv" ).hide ( ) ;
                  $ ( "#converterName" ).val("")
                }

            </script>
            <br />
            <button type="button" onclick="addConverter()">Create</button>
          </div>

          <input type="hidden" name="id" id="id" value='@frm("id").value'/>
          <input type="hidden" name="assertionId" id="assertionId" value='@frm("assertionId").value'/>
        </div>
      } <!-- helper.form -->
    } <!-- defininf -->
  } <!-- main -->
} <!-- defining test case -->