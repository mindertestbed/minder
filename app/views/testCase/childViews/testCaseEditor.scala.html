@(frm: Form[_], editMode: Boolean = true)

@import helper._
@import views.html.util._

@implicitFieldConstructor = @{
  FieldConstructor(myInput.f)
}

@getOrDummy() = @{
  val id = frm("id").value
  if (id == null || id.length == 0){
    val ta = TestAssertion.findById(frm("assertionId").value.toLong)
    val tc = new TestCase
    tc.name = "New Test Case"
    tc.testAssertion = ta
    tc
  } else {
    Tdl.findById(id.toLong).testCase
  }
}

@defining(getOrDummy()) { tc =>
  @main(Messages("minder.navigation.restricted.testdesigner"), "mainNavigation",
    Array(("Test Groups", controllers.routes.Application.testGroups().path()),
      (tc.testAssertion.testGroup.name, controllers.routes.GroupController.getGroupDetailView(tc.testAssertion.testGroup.id, "assertions").path()),
      (tc.testAssertion.taId, controllers.routes.TestAssertionController.getAssertionDetailView(tc.testAssertion.id, "cases").path()),
      (tc.name, controllers.routes.TestCaseController.viewTestCase(tc.id, "jobs").path()))) {

    @dialogs()

    <style>
    #accordion1 {
    height: 100% ;
    overflow:scroll ;
    }

    .myscroll {
    overflow:scroll ;
    width:100% ;

    background: rgb(200,230,255) ;
    }

    #editor {
    position: relative;
    top: 10px;
    right: 0;
    bottom: 0;
    left: 0px;
    height:700px;
    }

    </style>
    <script type="text/javascript" src="@routes.Assets.versioned("ace-builds/src-min/ace.js")"></script>
    <script>

        $(function() {
          minderAccordion("#accordion1");

          editor = ace.edit("editor");
          editor.setTheme("ace/theme/clouds");
          editor.getSession().setMode("ace/mode/scala");

          // store it
          $("#editor").data('AceInstance', editor);

          var content = $("#tdl");


          editor.getSession().on("change", function() {
            content.val(editor.getSession().getValue());
          });

          content.val(editor.getSession().getValue());
          //content.val(editor.getSession().getValue());
          //window.alert(content.val);

          $("#select").change(function () {
            $("#select option:selected").each(function () {
              var theme = "ace/theme/".concat($(this).text()) ;
              editor.setTheme(theme);

            });
          });
          document.onkeydown = function(event){
            if (event.which == 27){
              $("#wrappersDiv" ).hide();
              $ ( "#funcdiv" ).hide ( ) ;
            }
          };
        });
    </script>
    @defining(if(editMode == false) {
      routes.TestCaseController.doCreateCase()
    } else {
      routes.TestCaseController.doEditCase()
    }) { act =>
      @helper.form(action = act, 'class -> "fullh") {
        <div id="contentPane" style="position:absolute ; top:0px ; left:3px ; bottom: 3px ; right: 3px ;">
          <div class="bevel2" style="position:absolute ; width:100% ; height:50px ; margin:0 ; padding:10px ;">
            <table style="width: 100% ;">
              <tr>
                <td class="tabshrink">
                  <b>Test Case: </b>
                  @if(!editMode) {
                    <input type="text" name="name" value='@frm("name").value' style="border: 1px solid lightgrey ; background: white ; width:200px ;"/>
                  } else {
                    @frm("name").value
                    <input type="hidden" name="name" id="name" value='@frm("name").value'/>
                  }</td>
                <td class="tabshrink">
                    &nbsp;
                  <b>V</b>
                  : <input type="text" name="version" value='@frm("version").value' style="border: 1px solid lightgrey ; background: white ; width:40px ;"/>
                </td>
                <td align="right">
                  <table><tr><td>

                    <b>Theme</b>: <select id="select">
                    <option>chrome</option>
                    <option>eclipse</option>
                    <option>monokai</option>
                    <option>sqlserver</option>
                    <option selected>clouds</option>
                    <option>textmate</option>
                    <option>xcode</option>
                  </select>
                    <button onclick='$("#wrappersDiv").show();' type="button">Insert Reference</button>
                      &nbsp;
                    <button onclick='$ ( "#funcdiv" ).show( );' type="button">Insert Converter</button>
                      &nbsp;&nbsp;&nbsp;&nbsp;
                  <td align="right">
                    <button type="submit" action="save">Save</button>&nbsp;
                    &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                    <button type="button" onclick="history.back ( )">Cancel</button>
                  </td></tr></table>

                </td>
              </tr>
            </table>
          </div>
          <div style="position:absolute ; top:50px ; left:0 ; right:0 ; bottom: 0 ; margin:0 ; padding:5px ; overflow:auto ;">
            @if(frm.hasErrors) {
              <p id="error" class="alert alert-danger" style='font-family:"Monaco", "Courier New", "monospace"'></p>
              <xmp id="source" style="display: none">
                @if(frm.hasGlobalErrors) {
                  @frm.globalError
                }
                @if(frm.hasErrors) {
                  @for( error <- frm.errors) {
                    @for( err <- error._2) {
                      @error._1: @Messages(err.message)
                    }
                  }
                }
              </xmp>

              <script>
                  function trimAll(arr){
                    var arr2 = new Array()
                    for(a in arr){
                      arr[a] =arr[a].trim()
                      if (arr[a].length > 0) arr2.push(arr[a])
                    }
                    return arr2;
                  }
                  $(function(){
                    var newd  = $("#source" ).text()
                    newd = trimAll(newd.split(/\n/g)).join("<br/>");
                    newd = newd.replace(/ /g, '&nbsp;')
                    $("#error")[0 ].innerHTML = newd.trim();
                  });
              </script>
            }

            <div id="editor-container">
              <pre id="editor">@frm("tdl").value </pre>
            </div>

            @defining(if(frm("tdl").value == null) {
              ""
            } else {
              frm("tdl").value
            }) { str =>
              @defining(str.toString.split("\\\n").length) { len =>
                <script>
                    $(function(){
                      var editor1 = $("#tdl").data('AceInstance');

                      var nls = "";
                      for(i = @len; i < 20; i++){
                        nls += "\n"
                      }

                      editor1.replaceRange(nls, editor1.gotoLine(editor1.session.getLength()))
                    });
                </script>
              }
            }

          </div>

          <div class="bevel2" style="z-index:10000000 ; position:fixed ; width:60% ; height:60% ; top:20% ; left:20% ; display:none ; overflow:scroll ; border:1px solid gray ; background-color:#ffffff" id="wrappersDiv">
            <div id="accordion1" class="fullh">
            @defining(Wrapper.getAll()) { allWrappers =>
              @for( currentWrapper <- allWrappers) {
                @defining(WrapperVersion.latestByWrapper(currentWrapper)) { lastVersion =>
                  <div class="title bevelsmall"><b class="trigger">@currentWrapper.name</b></div>
                  <div class="content" style="height:95%">
                    <div class="myscroll" style="overflow:auto ;">
                    @if(lastVersion == null) {
                      The wrapper should connect at least once, to update its version and signatures.
                    } else {
                      <div><b>Signals</b></div>
                      <div style="overflow:scroll"> <ul>
                      @if(lastVersion.signals == null) {
                        No signals yet. The wrapper must connect at least once to update the signatures
                      } else {
                        @for( currentSignal <- lastVersion.signals) {
                          <li id="signal@lastVersion.id-@currentSignal.id">- @currentSignal.signature</li>
                          <script>
                      $("#signal@lastVersion.id-@currentSignal.id").click(function(){
                        var signalstring = "\"@currentSignal.signature\" of \"@currentWrapper.name\"";
                        editor.insert(signalstring);
                        $("#wrappersDiv" ).hide();
                      });

                      </script>
                        }
                      }
                      </ul></div>
                        &nbsp;
                      <div><b>Slots</b></div>
                      <div style="overflow:scroll">
                        <ul>
                        @if(lastVersion.slots == null) {
                          No slots yet. The wrapper must connect at least once to update the signatures
                        } else {
                          @for( currentSlot <- lastVersion.slots) {
                            <li id="slot@lastVersion.id-@currentSlot.id">- @currentSlot.signature</li>
                            <script>
                      $("#slot@lastVersion.id-@currentSlot.id").click(function(){

                        var slotstring = "\"@currentSlot.signature\" of \"@currentWrapper.name\"";

                        editor.insert(slotstring);
                        $("#wrappersDiv" ).hide();
                      });

                      </script>
                          }
                        }
                        </ul></div>
                    }
                    </div>
                  </div>
                }
              }
            }
            </div>
          </div>


          <div class="bevel2" style="z-index:10000000 ; position:fixed ; width:30% ; height:20% ; padding:20px ; top:40% ; left:35% ; display:none ; overflow:scroll ; border:1px solid gray ; background-color:#ffffff" id="funcdiv">

            <h3>Create New Converter</h3>

            <label for="converterName">Converter Name</label>
            <input type="text" id="converterName" class="fullw fcborder" />
            <br />

            <script>
                function addConverter() {
                  // get it

                  var convertertext = "def " + $ ( "#converterName" ).val() + "(input: Any) : Any ={\n\n}";

                  editor.insert(convertertext);

                  $ ( "#funcdiv" ).hide ( ) ;
                  $ ( "#converterName" ).val("")
                }

            </script>
            <br />
            <button type="button" onclick="addConverter()">Create</button>
          </div>

          <input type="hidden" name="id" id="id" value='@frm("id").value'/>
          <input type="hidden" name="assertionId" id="assertionId" value='@frm("assertionId").value'/>
          <input type="hidden" name="tdl" id="tdl" value = @frm("tdl").value/>
        </div>
      } <!-- helper.form -->
    } <!-- defininf -->
  } <!-- main -->
} <!-- defining test case -->